name: Railway Auto Switch

on:
  push:
    branches: [ main ]
  schedule:
    # Tous les jours Ã  2h du matin (Paris time)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Determine active Railway account
        id: account
        run: |
          # FORCE ACCOUNT 2 POUR LE TEST
          echo "active=2" >> $GITHUB_OUTPUT
          echo "ðŸ”µ TEST: Force dÃ©ploiement sur Account 2"
          
          # Pour la prod plus tard :
          # DAY=$(date +%d)
          # if [ $DAY -le 14 ]; then echo "active=1" >> $GITHUB_OUTPUT; else echo "active=2" >> $GITHUB_OUTPUT; fi

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH

      - name: Deploy
        env:
          RAILWAY_TOKEN: ${{ steps.account.outputs.active == '1' && secrets.RAILWAY_TOKEN_1 || secrets.RAILWAY_TOKEN_2 }}
          PROJECT_ID: ${{ steps.account.outputs.active == '1' && secrets.RAILWAY_PROJECT_1 || secrets.RAILWAY_PROJECT_2 }}
          SERVICE_ID: ${{ steps.account.outputs.active == '1' && secrets.RAILWAY_SERVICE_1 || secrets.RAILWAY_SERVICE_2 }}
        run: |
          railway up --project "$PROJECT_ID" --service "$SERVICE_ID" --detach

