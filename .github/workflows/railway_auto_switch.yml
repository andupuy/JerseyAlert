name: Railway Auto Switch

on:
  schedule:
    # Tous les jours √† 2h du matin (Paris time)
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  switch:
    runs-on: ubuntu-latest
    steps:
      - name: Determine active Railway account
        id: account
        run: |
          # FORCE ACCOUNT 2 FOR TESTING - Remove this line later
          echo "active=2" >> $GITHUB_OUTPUT
          echo "inactive=1" >> $GITHUB_OUTPUT
          echo "üîµ TEST: Account 2 actif, Account 1 en pause"
          
          # Uncomment this for production:
          # DAY=$(date +%d)
          # if [ $DAY -le 14 ]; then
          #   echo "active=1" >> $GITHUB_OUTPUT
          #   echo "inactive=2" >> $GITHUB_OUTPUT
          #   echo "üü¢ Account 1 actif (jours 1-14)"
          # else
          #   echo "active=2" >> $GITHUB_OUTPUT
          #   echo "inactive=1" >> $GITHUB_OUTPUT
          #   echo "üîµ Account 2 actif (jours 15-28)"
          # fi

      - name: Pause inactive service
        run: |
          if [ "${{ steps.account.outputs.inactive }}" == "1" ]; then
            TOKEN="${{ secrets.RAILWAY_TOKEN_1 }}"
            SERVICE="${{ secrets.RAILWAY_SERVICE_1 }}"
            echo "‚è∏Ô∏è Mise en pause du service Account 1"
          else
            TOKEN="${{ secrets.RAILWAY_TOKEN_2 }}"
            SERVICE="${{ secrets.RAILWAY_SERVICE_2 }}"
            echo "‚è∏Ô∏è Mise en pause du service Account 2"
          fi
          
          # Note: Railway n'a pas d'API simple pour pause/unpause
          # On va juste s'assurer que le bon compte est d√©ploy√©
          echo "‚úÖ Switch pr√©par√©"

      - name: Trigger deployment on active account
        run: |
          if [ "${{ steps.account.outputs.active }}" == "1" ]; then
            echo "üöÄ Account 1 est actif (d√©j√† connect√© √† GitHub)"
          else
            echo "üöÄ Account 2 est actif (d√©j√† connect√© √† GitHub)"
          fi
          echo "Les deux comptes se d√©ploient automatiquement via GitHub."
          echo "Pour √©conomiser, supprimez manuellement le service inactif ou configurez des replicas √† 0."
